generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String            @id @default(uuid())
  email             String            @unique
  name              String?
  password          String?
  googleId          String?           @unique
  preferences       Json?
  activeExamType    String?           @map("active_exam_type")
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  attempts          QuestionAttempt[]
  recommendations   Recommendation[]
  testSessions      TestSession[]

  @@map("users")
}

model QuestionAttempt {
  id               String       @id @default(uuid()) @map("attempt_id")
  userId           String       @map("user_id")
  questionMetadata Json         @map("question_metadata")
  correctness      Boolean
  confidenceRating Int          @map("confidence_rating")
  timeTakenSeconds Int          @map("time_taken_seconds")
  mistakeType      MistakeType? @map("mistake_type")
  testSessionId    String?      @map("test_session_id")
  attemptedAt      DateTime     @default(now()) @map("attempted_at")
  testSession      TestSession? @relation(fields: [testSessionId], references: [id])
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, attemptedAt])
  @@index([testSessionId])
  @@map("question_attempts")
}

model Recommendation {
  id              String    @id @default(uuid()) @map("recommendation_id")
  userId          String    @map("user_id")
  examType        String    @map("exam_type")
  // Card array: [{ priority, topic, subject, confidence, dataPoints, why, actions }]
  cards           Json      @default("[]")
  // Status: INSUFFICIENT_DATA | NO_SIGNIFICANT_RISKS | HAS_RECOMMENDATIONS
  status          String    @default("INSUFFICIENT_DATA")
  // Evidence: aggregated metrics (for audit trail)
  evidence        Json      @default("{}")
  generatedAt     DateTime  @default(now()) @map("generated_at")
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Unique per (user, examType) - ONE recommendation per exam per user
  @@unique([userId, examType], name: "userId_examType")
  @@index([userId, examType])
  @@index([userId, generatedAt])
  @@map("recommendations")
}

model TestSession {
  id             String            @id @default(uuid()) @map("session_id")
  userId         String            @map("user_id")
  testName       String            @map("test_name")
  testDate       DateTime          @map("test_date")
  examType       String?           @map("exam_type")
  source         String?           @map("source")
  overallScore   Float?            @map("overall_score")
  totalQuestions Int               @map("total_questions")
  totalTime      Int               @map("total_time")
  attempts       QuestionAttempt[]
  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, testDate])
  @@map("test_sessions")
}

enum MistakeType {
  conceptual
  calculation
  misread
  guess
}
